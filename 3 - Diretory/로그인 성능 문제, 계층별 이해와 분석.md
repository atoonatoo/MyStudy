---
created:
---

---
- [[Home]]
- [[2 - Category/Learning]]
- [[로그 수집 시스템 구축 (Filebeat + Elasticsearch + Kibana)]]
---
- [[#개요]]
- [[#확인 순서]]
- [[#현재 문제 상황 인지 및 설명]]
- [[#CPU, 메모리, GC 로그 확인]]
---
### 개요
hikari pool size를 16으로 감소 조절하여 5분 9,000 요청을 처리하면서 에러율 0%로 정상동작이 된다는 것을 확인하며 해결..한줄 알았지만, 다시 에러가 발생했다. 내가 왜 이러한 문제와 현상이 생겼는지 설명을 못하고있다는 사실을 자각하였다. 따라서 나는 이전에 있던 개념들을 차근차근 하나씩 다시 되짚어보면서 해당 설정들을 이해하고 설명할 수 있도록 정리해보려고 한다. 시작은 서버단부터 올라가는 방향으로 진행할 것이다.

---
### 확인 순서
1. 현재 문제 상황 인지 및 설명
2. CPU, 메모리, GC 로그 확인
    1. CPU, 메모리(heap 등), GC 로그 이해하고 확인
3. application.yml 확인
    1. 각 설정 이해하고 확인
4. 소스코드 확인
    1. 로그인 로직 소스 코드 이해하고 확인
5. db 확인
    1. 커넥션 풀, 인덱스 여부 등 이해하고 확인
    2. 서버 로그를 강화해서 히카리풀 또는 하이버네이트 로그 확인
6. mysql 확인
    1. mysql 풀사이즈 설정, 타임아웃 설정 찾아보고 적절하게 조정
7. hikari 확인
    1. hikari 설정 이해하고 확인
8. tomcat thread 확인
    1. tomcat 설정  이해하고 확인
9. nginx 확인
    1. conf 이해하고 확인
10. jmeter확인
    1. 세팅이 정상적인지 이해하고 확인

---
### 현재 문제 상황 인지 및 설명

Jmeter로 내가 만든 로그인 기능의 부하 테스트를 진행하여 20000명 유저를 5분간 분산하여 부하를 주었다. 
상대적으로 적은 양의 부하를 주었음에도 에러가 평균 30%이상 발생하고 로그인 요청에 대한 평균 응답 시간이 3초 이상 발생
로그인 요청 응답시간을 정상적으로 줄이기 위해 원인을 찾도록 하였다.
중요한 것은 단순한 추측으로 내가 여기저기 확인해보는 것이 아닌 로그인 응답 지연의 원인이 되는 로그라는 명확한 증거를 발견하고
그 원인에 대해 올바른 고민을하고 문제에 대한 해결 수단을 내가 직접 찾고 적용하여 문제에 대한 해결을 하는 것이 궁극의 목표이다.
여기서 추가적으로 문제를 발견하였다.
우선 Jmeter test에 대한 에러 로그(스택트레이스)가 서버에 뜨지 않는다.
서버에서 로그가 안뜨기 때문에 증거가되는 명확한 로그를 볼 수 없다.
따라서 내가 해본 시도는 log 수집 시스템을 세팅하여 재대로 확인해보았다.
filebeat, elasticsearch, kibana를 통해 파일비트가 수집한 로그를 모아서 엘라스틱서치 그 로그를 읽고 키바나가 그것을 시각화하여
보다 효율적으로 로그 관리하여 문제를 찾아보기 위함이었다.
하지만 여전히 로그인 실패에 대한 유의미한 로그를 찾아 볼 수 없었다.
server에서는 확인을 못하였기 때문에 nginx에도 로그를 수집하여 확인해 본 결과
`8080~8087 upstream timed out` 에러를 확인하였다. 이 에러의 의미를 이해하고 원인이 되는지 확인해야한다.
그 밖에도 hikari pool size(16으로 감소 조절), nginx 설정을 조정하여 테스트해본 결과
9000명을 5분간 부하테스트한 결과 에러율 0%라는 처음으로 유의미한 결과를 확인하였다.
20000명을 5분간 부하테스트한 결과에 대해선 여전히 문제가 발생하였다. 
여기서 내가 막연하게 설정 및 테스트하고 왜 이런 결과가 나왔는지 설명을 못하며, 
막연하고 어떻게 손을 봐야하는지 감을 못잡았다는걸 깨달았다.
차근차근.. 내가 지금까지 거쳐왔던 모든 개념들을 완벽하게 이해할 필요가 있다고 느꼈다.
멘토님께서 주신 과제와 동시에 병행하도록 하자.
1. 모든 개념을 설명할 수 있도록 이해한다.
2. 서버 로그를 강화해서 히카리풀 또는 하이버네이트 로그를 발견하자

---
### CPU, 메모리, GC 로그 확인