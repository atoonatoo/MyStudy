
---
- [[Test]]
---

# 1. 서버 성능 테스트

## 1.1 성능 테스트를 해야하는 이유

2017년 구글 발표 자료에 따르면..모바일 환경에서 로드 타임이 1 ~ 3초가 걸린다면 사용자가 서비스 이탈률이 32% 증가한고, 5초 이상 10초 이상은 90% ~123% 가까이 올라간다는 것을 수치상 확인할 수 있었다.

이러한 조사결과를 바탕으로 우리가 이탈률을 감소시킬 수 있는 가장 확실한 방법은 응답 대기 시간을 줄이는 것이다.

이러한 응답 대기 시간을 줄이기 위해선 어떻게 해야하는지 확인 볼 것이다.

즉 성능 테스트는 `처리 속도 저하`, `서버 응답 불가`, `서버 오류 발생` 같은 문제들이 발생할 수 있기 때문에, 서비스 출시 이전에 반드시 필요한 테스트이다.
	
---

## 1.2 가용성이란? (Availability)

- 시스템이 서비스를 정상적으로 제공할 수 있는 상태 
- 성능 테스트에서는 "부하가 걸려도 시스템이 정상 작동했는가?"를 보는 핵심 지표 중 하나이다.
    
---

## 1.3 설정한 목표치 달성

내가 사용자에게 제공할 서비스에 문제가 없도록 스스로 목표치를 설정하고 그 목표치를 달성하도록 계획을 세워야한다.
- 예시
	1. 초당 1000건의 요청 처리, 모든 조회 요청을 1초 이내로 응답
	2. 배포 전 성능 테스트를 통해 배포치를 만족하는지 확인
	   
---

### 1.3.1 어떤 지표를 확인해야하는가?

- 초당 1000건 요청 처리 -> `Troughput(처리량)`
- 모든 조회 요청을 1초 이내로 응답 -> `Latency(응답 시간)`
	
---

#### 1.3.1.1 처리량 (Throughput)
	- 초당 처리하는 작업의 수를 의미
	- `RPS`(Request Per Second) : 1초에 처리하는 HTTP 요청의 수

    
- **처리량 성능 개선 방법**
	1. 현재 시스템 처리량 확인 방법은?
	2.  서브 시스템 중에 가장 낮은 가장 낮은 RPS를 병목 구간으로 측정
	3. 가장 낮은 병목 구간을 성능 개선한다.
	4. 그렇다면 병목 구간은 그 다음으로 RPS가 낮은 곳으로 이동하게 된다.
	5. 단, 병목 구간이 아닌 곳을 성능 개선하면 전체적인 성능 개선에 실패한다.    

---

#### 1.3.1.2 응답 시간 (Latency)
- 현재 시스템의 응답 시간 확인하는 방법
- `각 서브 시스템 응답 시간의 총합을 계산한다.`
- 시스템의 요청을 받고 응답할 때까지의 시간을 의미
- 시스템이 요청을 처리할 때까지 대기하는 시간도 응답 시간에 포함된다.
- 단위는 `ms`를 사용한다. -> 100 ms
- 어떤부분을 개선하더라도 시스템의 총 응답 시간에 영향을 준다.
- 따라서 응답 시간이 긴 서브 시스템 우선순위로 성능을 개선 해야한다.

---
	
#### 1.3.1.3 성능 테스트 지표의 상관관계

- 처리량 개선 - 짧은 대기 시간으로 응답 시간 개선
- 응답시간 개선 - 요청을 빠르게 처리하니 처리량 개선

---

# 2. 성능 테스트의 종류

## 2.1 스모크 테스트

- 최소한의 부하를 주어 시스템이 정상적으로 동작하는지 확인
- 부하 테스트를 시작하기전에 테스트 스크립트가 정상적으로 동작하는지 확인하기도 한다.

![](https://velog.velcdn.com/images/atoonatoo/post/f5978173-addc-4b50-b0ba-d82e2a91cadf/image.png)

---
## 2.2 스파이크 테스트

- 사용량이 급증하는 상황에서 시스템이 견디고 성능에 문제가 없는지 확인

![](https://velog.velcdn.com/images/atoonatoo/post/b1dadcee-c5d0-4772-96df-c42cb032074b/image.png)


---
## 2.3 부하 테스트

- 목표값에 해당되는 부하를 견딜 수 있는지 확인
- 가장 일반적인 테스트 방법 시스템
- 시스템의 구성이 변경되었을 때도 이전과 동일한 부하를 견딜 수 있는지 확인할 수도 있다.

![](https://velog.velcdn.com/images/atoonatoo/post/b94af5ee-9dea-4cf1-8a05-61631c114ac3/image.png)

---

## 2.4 스트레스 테스트

- 시스템의 최대치에 해당되는 부하를 받았을 때 시스템이 어떻게 동작하는지 확인
- 스트레스 테스트를 먼저 진행하면, 병목 구간을 확인하기 힘들어지기 때문에 부하 테스트를 먼저 진행하고 스트레스 테스트를 진행하는 것이 권장된다. 

![](https://velog.velcdn.com/images/atoonatoo/post/204ba698-d9d2-4824-b567-66e88e093142/image.png)

---
## 2.5 내구 테스트

- 평균 사용률로 일정 부하를 지속적으로 주며 시스템이 문제되는 지점을 확인
- 흡수 테스트(Soak Test)라고도 한다.

![](https://velog.velcdn.com/images/atoonatoo/post/f7263a64-3641-4dc8-8a87-a9d840034e49/image.png)

---

## 2.6 중단점 테스트

- 임계 지점을 찾기 위해 부하를 점진적으로 증가하며 진행한다.
- 시스템의 한계지점을 파악하기 위함

![](https://velog.velcdn.com/images/atoonatoo/post/0c0877db-b169-474d-91bc-59535c057d81/image.png)

---

## 2.7 성능 테스트 그래프

-  모든 테스트의 그래프를 한눈에 보고 비교해보자.

![](https://velog.velcdn.com/images/atoonatoo/post/1f4fa537-dbdb-46d8-8c0a-b873b311b799/image.png)

---

## 3. 성능 테스트 도구

## 3.1 JMeter

- Apache에서 만든 오픈 소스 소프트웨어이다.

---

### 3.1.1 장점

1. 많은 릴리즈와 개선사항을 통해 고도로 유지, 관리
2. 다양한 프로토콜 제공
	- 웹 - HTTP, HTTPS
	- SOAP - REST 웹 서비스
	- FTP
	- 데이터베이스 - JDBC
	-  Mail (SMTP, POP3, IMAP)
3. 다양한 플러그인 제공
	- InteliJ 등 

---

### 3.1.2 단점

1. 어플리케이션이 굉장히 오래되었는지, 복잡한 스크립트와 문서 부족하다.
2. 한대의 Warker에서 사용할 수 있는 사용자 수가 매우 한정적이다.
3. GUI와 CLI를 모두 지원하지만, GUI의 모드에서 28배 더 많은 메모리를 사용되기 때문에, CLI를 권장한다.
4. 기본적으로 제공되는 그래프의 가독성이 좋지 않다.

---

## 3.2 k6

- Grafana Labs에서 만든 소프트웨어이다.
- JS을 사용한다.

---
### 3.2.1 장점

1. 깔끔한 공식 문서
2. 비교적 간편한 스크립트
3. 적은 메모리 사용
4. 다양한 GUI 제공

---

### 3.2.2 단점

1. 클라우드 서비스를 이용하려면 유료 서비스를 이용해야한다.
	-  프리티어 기준까지는 무료로 이용 가능하다.
2. 확장성 한계
	- 부하 테스트 , 대용량 트래픽 불가능하기 때문에 k6 + k8s or k6 operator를 같이 사용해야한다.

---

## 3.3 nGinder

- Naver에서 만든 오픈소스 소프트웨어이다.

---

### 3.1.1 장점

1. Java와 비슷한 스크립트 언어 지원한다.
	- Grooby, Jython
2. 한국어를 지원한다.
3. 완성도 높은 뼈대코드 지원한다.
	- 스크립트 이름 + 도메인 주소 + 요청을 보낼 API
4. 가독성이 좋은 GUI를 제공한다.

---

### 3.1.2 단점

1. 분리된 프로세스
	- controller 실행 명령, agent 실행 명령
2. 테스트 스크립트 IDE 미지원

---

# 4. 테스트 계획 수립

---

## 4.1 응답의 최소 레이턴시(latency) 정하기

-  위의 #1 항목을 보면 응답률이 1초 이상이면 유저가 이탈하기 때문에 성능을 개선해야한다. 
  
- 목표 
	- 최대 지연시간을 = 0.3초

---

## 4.2 서비스의 사용자 수가 peak일 때의 수 구하기

- 예시
	- 출퇴근 시간의 대중교통 관련 서비스 
	- 페어 매칭 시간의 LMS
	- 성수기의 숙박 예약 서비스
	  
- 측정을 할 때는 사용자가 가장 많을 때 보다 더 넉넉하게 측정해야 한다.

---

## 4.3 테스트 시나리오 - 목표

1. 응답 지연 시간은 300ms 이하여야 한다.
2. 서비스의 동시 사용자 수는 넉넉잡아 200명이다.

---

## 4.4 테스트 스크립트 작성 (Tool : nGrinder)


![](https://velog.velcdn.com/images/atoonatoo/post/f0e2b228-5c2f-4650-9825-a23568ad94bd/image.png)

---

## 4.5 테스트 스크립트 작성

![](https://velog.velcdn.com/images/atoonatoo/post/f127329e-9c87-4707-806a-d644869549af/image.png)

---
### 4.5.1  Vuser 설정

![](https://velog.velcdn.com/images/atoonatoo/post/c1b22dd0-1594-478a-8188-969ed2cdfda1/image.png)


---

### 4.5.2 Duration / Run Count 옵션

![](https://velog.velcdn.com/images/atoonatoo/post/f41ac859-7ef9-4337-9d3f-1157628a91ef/image.png)


---

### 4.5.3 Enable Ramp-Up

![](https://velog.velcdn.com/images/atoonatoo/post/715af874-3605-42c9-96a7-d933de57389d/image.png)


---

## 4.6 Load 테스트

![](https://velog.velcdn.com/images/atoonatoo/post/eabeb800-a8eb-4431-9988-5784b0e4eab4/image.png)

- 왼쪽은 상세 수치 오른쪽은 그래프로 결과를 나타난 걸 볼 수 있다.

---

### 4.6.1 수치

![](https://velog.velcdn.com/images/atoonatoo/post/952a942d-a291-4381-8a2e-b24464e84a1c/image.png)

---

### 4.6.2 그래프

![](https://velog.velcdn.com/images/atoonatoo/post/bd99d75e-a158-4718-9969-ef7edbeb4eff/image.png)

- Peak TPS가 495까지 도달한 것을 볼 수 있다. 
- 이 기점부터 정상적인 요청 처리량이 줄어듬을 볼 수 있다.
- 이 기점부터 응답률이 낮아지기 때문에 사용자는 오래 기다려야하는 경험을 느끼게 된다.

---

### 4.6.3 Vuser와 Error 그래프

![](https://velog.velcdn.com/images/atoonatoo/post/5d34a218-591a-4eba-857b-c9105b4409ae/image.png)

- Vuser가 증가할 수록 19분부터 Error가 증가함을 알 수 있다. 
- 이부분부터 성능을 개선해줘야하는 포인트로 볼 수 있다.

---

### 4.6.4 결론

1. 해당 API에 대한 점진적 성능개선을 시작해야한다.
2. 임계 지점에서 내가 설정한 레이턴시 값을 만족하도록 성능을 개선해야 한다.
	- 캐싱 처리
	- 쿼리 튜닝
	- N+1 해결

---

# 참고 문헌

- [참고 블로그](https://velog.io/@kimhalin/%EC%84%9C%EB%B2%84-%EB%B6%80%ED%95%98-%ED%85%8C%EC%8A%A4%ED%8A%B8-K6#k6)
- [참고 블로그](https://inpa.tistory.com/entry/JEST-%F0%9F%93%9A-%EB%B6%80%ED%95%98-%ED%85%8C%EC%8A%A4%ED%8A%B8-Stress-Test)
- [참고 유튜브](https://www.youtube.com/watch?v=IcSdPhxCn9Y&pp=ygUZSzYg7Iqk7YyM7J207YGsIO2FjOyKpO2KuA%3D%3D)
- [참고 유튜브](https://www.youtube.com/watch?v=3cTn53dtzJI)